<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel æª¢è¦–å™¨ - å¤šæª”æ¡ˆæ•´åˆå·¥å…·</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1400px; margin: 0 auto; background: white;
            border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px; text-align: center;
        }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1rem; }
        .content { padding: 30px; }
        #drop-area {
            border: 3px dashed #667eea; border-radius: 12px; padding: 60px 20px;
            text-align: center; background: #f8f9fa; cursor: pointer;
            transition: all 0.3s ease; margin-bottom: 30px;
        }
        #drop-area.compact {
            padding: 20px; display: flex; align-items: center;
            justify-content: space-between; text-align: left;
        }
        #drop-area:hover, #drop-area.highlight {
            background: #e9ecef; border-color: #764ba2; transform: translateY(-2px);
        }
        #drop-area h3 { color: #667eea; margin-bottom: 15px; font-size: 1.5rem; }
        #drop-area.compact h3 { margin-bottom: 0; font-size: 1.1rem; }
        #drop-area p { color: #6c757d; margin-bottom: 20px; }
        #drop-area.compact p { margin-bottom: 0; font-size: 0.9rem; }
        #file-input { display: none; }
        .btn-upload {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 12px 30px;
            border-radius: 8px; font-size: 1rem; cursor: pointer; transition: all 0.3s ease;
        }
        .btn-upload:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        #import-options-container {
            background: #f8f9fa; border-radius: 12px; padding: 20px;
            margin-bottom: 20px; border: 1px solid #e9ecef;
        }
        #import-options-container fieldset { border: none; padding: 0; margin: 0; }
        #import-options-container legend {
            font-weight: 600; color: #495057; padding-bottom: 10px;
            margin-bottom: 10px; width: 100%; border-bottom: 1px solid #dee2e6;
            font-size: 1.1rem;
        }
        .import-option { display: block; margin-bottom: 10px; cursor: pointer; }
        .import-option input[type="radio"] { margin-right: 8px; }
        .input-group { margin-top: 10px; margin-left: 25px; }
        .input-group input[type="text"] {
            padding: 8px 12px; border: 2px solid #dee2e6; border-radius: 6px;
            font-size: 0.9rem; transition: border-color 0.3s ease;
        }
        .input-group input[type="text"]:focus { outline: none; border-color: #667eea; }
        .file-info { display: flex; align-items: center; gap: 15px; flex: 1; }
        .file-info-text { flex: 1; }
        .file-count {
            display: inline-block; background: #667eea; color: white;
            padding: 4px 12px; border-radius: 20px; font-size: 0.9rem;
            font-weight: 600; margin-left: 10px;
        }
        .btn-clear {
            background: #dc3545; color: white; border: none; padding: 8px 20px;
            border-radius: 6px; font-size: 0.9rem; cursor: pointer;
            transition: all 0.3s ease; white-space: nowrap;
        }
        .btn-clear:hover { background: #c82333; transform: translateY(-1px); }
        .controls { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 30px; }
        .control-group { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #e9ecef; }
        .control-group:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }
        .control-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        .control-group input[type="text"] {
            width: 100%; padding: 10px 15px; border: 2px solid #dee2e6;
            border-radius: 8px; font-size: 1rem; transition: border-color 0.3s ease;
        }
        .control-group input[type="text"]:focus { outline: none; border-color: #667eea; }
        .checkbox-label { display: inline-flex; align-items: center; cursor: pointer; font-weight: normal; }
        .checkbox-label input[type="checkbox"] { margin-right: 8px; cursor: pointer; }
        .button-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .btn {
            padding: 10px 20px; border: none; border-radius: 8px; font-size: 0.95rem;
            cursor: pointer; transition: all 0.3s ease; font-weight: 500;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .hidden { display: none !important; }
        .status-message {
            background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px;
            border-radius: 8px; margin-bottom: 20px; color: #856404;
        }
        .info-feedback-box {
            background-color: #e6f7ff; border: 1px solid #b3e0ff;
            border-radius: 8px; padding: 12px 15px; margin-top: 15px;
        }
        .info-feedback-box h5 {
            margin: 0 0 8px 0; color: #004085; font-size: 0.9rem;
        }
        .info-feedback-box p {
            font-size: 0.85rem; color: #0056b3; margin: 0;
            max-height: 60px; overflow-y: auto;
        }
        .info-box {
            background: #e6f7ff; border-left: 4px solid #007bff; padding: 15px;
            border-radius: 8px; margin-top: 20px; color: #0056b3; font-size: 0.9rem;
        }
        .info-box h4 { margin-top: 0; margin-bottom: 10px; color: #004085; }
        .info-box ul { margin-left: 20px; padding-left: 0; }
        .info-box li { margin-bottom: 5px; }
        .info-box li ul { margin-top: 5px; }
        .table-wrapper {
            margin-bottom: 30px; border: 1px solid #dee2e6;
            border-radius: 12px; overflow: hidden; background: #fff;
        }
        .table-header {
            display: flex; align-items: center; gap: 10px; padding: 10px 15px;
            background-color: #f8f9fa; border-bottom: 1px solid #dee2e6;
        }
        .table-header input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .table-header h4 {
            margin: 0; font-size: 1rem; font-weight: 600; color: #495057;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        #excel-display-area { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 0; box-shadow: none; border-radius: 0; }
        table thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        table th { padding: 15px 12px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        table td { padding: 12px; border-bottom: 1px solid #dee2e6; }
        table tbody tr:hover { background: #f8f9fa; }
        .checkbox-cell { width: 50px; text-align: center; }
        .checkbox-cell input[type="checkbox"] { cursor: pointer; width: 18px; height: 18px; }
        .filename-cell {
            background-color: #e9ecef; font-size: 0.7em; color: #495057;
            font-weight: 500; width: 150px; white-space: normal; overflow-wrap: break-word;
        }
        .row-hidden-search { display: none; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 1000;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-dialog {
            background: white; padding: 25px 30px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 90%;
            max-width: 500px; max-height: 80vh; display: flex; flex-direction: column;
        }
        .modal-header { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #dee2e6; }
        .modal-header h3 { margin: 0; color: #343a40; font-size: 1.25rem; }
        .modal-header p { margin: 5px 0 0; color: #6c757d; font-size: 0.9rem; }
        .modal-body { overflow-y: auto; margin-bottom: 20px; flex-grow: 1; }
        .sheet-list { list-style: none; padding: 0; margin: 0; }
        .sheet-item { padding: 10px 5px; border-bottom: 1px solid #f1f3f5; }
        .sheet-item:last-child { border-bottom: none; }
        .sheet-item label { display: flex; align-items: center; cursor: pointer; font-size: 1rem; color: #495057; }
        .sheet-item input[type="checkbox"] { margin-right: 12px; width: 18px; height: 18px; cursor: pointer; }
        .modal-quick-actions { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e9ecef; display: flex; gap: 10px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; }
        @media (max-width: 768px) {
            .header h1 { font-size: 1.5rem; }
            .button-group { flex-direction: column; }
            .btn { width: 100%; }
            table { font-size: 0.85rem; }
            table th, table td { padding: 8px; }
        }
        .loading { text-align: center; padding: 40px; color: #667eea; font-size: 1.2rem; }
        .loading::after { content: '...'; animation: dots 1.5s steps(4, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>ğŸ“Š Excel æª¢è¦–å™¨</h1><p>æ”¯æ´å¤šæª”æ¡ˆã€å¤šå·¥ä½œè¡¨æ•´åˆ | å¼·å¤§çš„ç¯©é¸èˆ‡åŒ¯å‡ºåŠŸèƒ½</p></div>
        <div class="content">
            <div id="import-options-container">
                <fieldset>
                    <legend>âš™ï¸ æ­¥é©Ÿä¸€ï¼šé¸æ“‡åŒ¯å…¥æ–¹å¼</legend>
                    <label class="import-option"><input type="radio" name="import-mode" value="all"> åŒ¯å…¥æ‰€æœ‰å·¥ä½œè¡¨</label>
                    <label class="import-option"><input type="radio" name="import-mode" value="first" checked> åƒ…åŒ¯å…¥ç¬¬ä¸€å¼µå·¥ä½œè¡¨</label>
                    <label class="import-option"><input type="radio" name="import-mode" value="position"> åŒ¯å…¥æŒ‡å®šä½ç½®çš„å·¥ä½œè¡¨</label>
                    <div id="specific-sheet-position-group" class="input-group hidden"><input type="text" id="specific-sheet-position-input" placeholder="ä¾‹å¦‚: 1, 3, 5-7"></div>
                    <label class="import-option"><input type="radio" name="import-mode" value="specific"> åŒ¯å…¥æŒ‡å®šåç¨±çš„å·¥ä½œè¡¨</label>
                    <div id="specific-sheet-name-group" class="input-group hidden"><input type="text" id="specific-sheet-name-input" placeholder="è«‹è¼¸å…¥å·¥ä½œè¡¨åç¨±é—œéµå­—"></div>
                    <label class="import-option"><input type="radio" name="import-mode" value="manual"> é€ä¸€æª”æ¡ˆæ‰‹å‹•æ±ºå®š</label>
                </fieldset>
            </div>
            <div id="drop-area">
                <input type="file" id="file-input" accept=".xls,.xlsx" multiple>
                <div id="drop-area-initial"><h3>ğŸ“ æ­¥é©ŸäºŒï¼šæ‹–æ”¾æª”æ¡ˆåˆ°æ­¤è™•</h3><p>æˆ–é»æ“Šä¸‹æ–¹æŒ‰éˆ•é¸æ“‡æª”æ¡ˆ</p><button class="btn-upload">é¸æ“‡ Excel æª”æ¡ˆ</button></div>
                <div id="drop-area-loaded" class="hidden"><div class="file-info"><div class="file-info-text"><h3>ğŸ“Š å·²è¼‰å…¥æª”æ¡ˆ <span class="file-count" id="file-count">0</span></h3><p id="file-names">-</p></div><button class="btn-clear" id="clear-files-btn">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æª”æ¡ˆ</button></div></div>
            </div>
            <div class="controls hidden" id="control-panel">
                <div class="control-group" id="table-level-controls">
                    <label>ğŸ“‹ è¡¨æ ¼å±¤ç´šæ“ä½œ</label>
                    <div class="button-group">
                        <button class="btn btn-primary" id="select-all-tables-btn" title="å‹¾é¸æ‰€æœ‰å·²è¼‰å…¥çš„è¡¨æ ¼">å‹¾é¸æ‰€æœ‰è¡¨æ ¼</button>
                        <button class="btn btn-secondary" id="unselect-all-tables-btn" title="å–æ¶ˆå‹¾é¸æ‰€æœ‰è¡¨æ ¼">å–æ¶ˆå‹¾é¸æ‰€æœ‰è¡¨æ ¼</button>
                        <button class="btn btn-danger" id="delete-selected-tables-btn" title="æ°¸ä¹…åˆªé™¤æ‰€æœ‰å·²å‹¾é¸çš„è¡¨æ ¼">åˆªé™¤é¸å®šè¡¨æ ¼</button>
                    </div>
                    <div id="selected-tables-info" class="info-feedback-box hidden">
                        <h5>ç›®å‰é¸å–çš„è¡¨æ ¼ï¼š</h5>
                        <p id="selected-tables-list"></p>
                    </div>
                </div>
                <div class="control-group">
                    <label for="search-input">ğŸ” è³‡æ–™åˆ—ç¯©é¸èˆ‡æ“ä½œ</label>
                    <input type="text" id="search-input" placeholder="è¼¸å…¥é—œéµå­—ä»¥ç¯©é¸è³‡æ–™åˆ—...">
                </div>
                <div class="control-group hidden" id="select-by-keyword-group">
                    <input type="text" id="select-keyword-input" placeholder="å¤šé—œéµå­—ç”¨ç©ºæ ¼(AND)æˆ–é€—è™Ÿ(OR)åˆ†éš”ï¼Œæˆ–ä½¿ç”¨ Regex">
                    <label class="checkbox-label"><input type="checkbox" id="select-keyword-regex"> ä½¿ç”¨æ­£è¦è¡¨ç¤ºå¼ (Regex)</label>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary hidden" id="select-by-keyword-btn">ä¾é—œéµå­—å‹¾é¸</button>
                    <button class="btn btn-primary hidden" id="select-empty-btn">å‹¾é¸ç©ºç™½åˆ—</button>
                    <button class="btn btn-primary hidden" id="select-all-btn">å‹¾é¸å…¨éƒ¨</button>
                    <button class="btn btn-warning hidden" id="invert-selection-btn">åå‘é¸å–</button>
                    <button class="btn btn-danger hidden" id="delete-selected-btn">åˆªé™¤å‹¾é¸åˆ—</button>
                </div>
                <div class="control-group">
                     <label>ğŸ”„ å…¨å±€èˆ‡åŒ¯å‡º</label>
                     <div class="button-group">
                        <button class="btn btn-info hidden" id="show-hidden-btn">é¡¯ç¤ºéš±è—çš„è¡Œåˆ—</button>
                        <button class="btn btn-success hidden" id="export-html-btn">åŒ¯å‡º HTML (å…¨éƒ¨)</button>
                        <button class="btn btn-success hidden" id="export-selected-btn">åŒ¯å‡º HTML (é¸å–)</button>
                        <button class="btn btn-success hidden" id="export-xlsx-btn">åŒ¯å‡º XLSX (å…¨éƒ¨)</button>
                        <button class="btn btn-success hidden" id="export-selected-xlsx-btn">åŒ¯å‡º XLSX (é¸å–)</button>
                        <button class="btn btn-success hidden" id="export-merged-xlsx-btn">åˆä½µæ‰€æœ‰è¡¨æ ¼</button>
                        <button class="btn btn-secondary hidden" id="reset-view-btn">é‚„åŸå§‹åˆç‹€æ…‹</button>
                    </div>
                </div>
                <div class="info-box hidden" id="export-info-box"><h4>ğŸ’¡ åŒ¯å‡ºåŠŸèƒ½èªªæ˜</h4><ul><li><strong>åˆªé™¤ (Delete)ï¼š</strong>ä½¿ç”¨ã€Œåˆªé™¤å‹¾é¸åˆ—ã€æˆ–ã€Œåˆªé™¤é¸å®šè¡¨æ ¼ã€æŒ‰éˆ•å¾Œï¼Œè³‡æ–™å°‡<strong>æ°¸ä¹…ç§»é™¤</strong>ã€‚</li><li><strong>ç¯©é¸ (Filter)ï¼š</strong>ä½¿ç”¨ã€Œå³æ™‚æœå°‹ã€åŠŸèƒ½æœƒæš«æ™‚éš±è—è³‡æ–™åˆ—ã€‚<ul><li><code>åŒ¯å‡º XLSX</code> å’Œ <code>åˆä½µè¡¨æ ¼</code>ï¼š<strong>ä¸æœƒ</strong>åŒ…å«è¢«ç¯©é¸éš±è—çš„åˆ—ã€‚</li><li><code>åŒ¯å‡º HTML</code>ï¼š<strong>æœƒ</strong>åŒ…å«è¢«ç¯©é¸éš±è—çš„åˆ—ã€‚</li></ul></li></ul></div>
            </div>
            <div class="status-message hidden" id="load-status-message"></div>
            <div id="excel-display-area"></div>
        </div>
    </div>

    <script>
        const ExcelViewer = (() => {
            'use strict';

            const CONSTANTS = { VALID_FILE_EXTENSIONS: ['.xls', '.xlsx'] };
            const state = { originalHtmlString: '', isProcessing: false, loadedFiles: [], loadedTables: 0 };
            const elements = {};

            function init() {
                cacheElements();
                bindEvents();
            }

            function cacheElements() {
                const ids = [
                    'fileInput', 'displayArea', 'searchInput', 'dropArea', 'deleteSelectedBtn', 'invertSelectionBtn', 
                    'resetViewBtn', 'selectEmptyBtn', 'exportHtmlBtn', 'showHiddenBtn', 'exportSelectedBtn', 
                    'exportXlsxBtn', 'exportSelectedXlsxBtn', 'exportMergedXlsxBtn', 'selectByKeywordGroup', 
                    'selectKeywordInput', 'selectByKeywordBtn', 'selectKeywordRegex', 'loadStatusMessage', 
                    'controlPanel', 'dropAreaInitial', 'dropAreaLoaded', 'fileCount', 'fileNames', 
                    'clearFilesBtn', 'selectAllBtn', 'exportInfoBox', 'importOptionsContainer', 
                    'specificSheetNameGroup', 'specificSheetNameInput', 'specificSheetPositionGroup', 
                    'specificSheetPositionInput', 'selectAllTablesBtn', 'unselectAllTablesBtn', 
                    'deleteSelectedTablesBtn', 'tableLevelControls', 'selectedTablesInfo', 'selectedTablesList'
                ];
                const mapping = {
                    'fileInput': 'file-input', 'displayArea': 'excel-display-area', 'searchInput': 'search-input',
                    'dropArea': 'drop-area', 'deleteSelectedBtn': 'delete-selected-btn', 'invertSelectionBtn': 'invert-selection-btn',
                    'resetViewBtn': 'reset-view-btn', 'selectEmptyBtn': 'select-empty-btn', 'exportHtmlBtn': 'export-html-btn',
                    'showHiddenBtn': 'show-hidden-btn', 'exportSelectedBtn': 'export-selected-btn', 'exportXlsxBtn': 'export-xlsx-btn',
                    'exportSelectedXlsxBtn': 'export-selected-xlsx-btn', 'exportMergedXlsxBtn': 'export-merged-xlsx-btn',
                    'selectByKeywordGroup': 'select-by-keyword-group', 'selectKeywordInput': 'select-keyword-input',
                    'selectByKeywordBtn': 'select-by-keyword-btn', 'selectKeywordRegex': 'select-keyword-regex',
                    'loadStatusMessage': 'load-status-message', 'controlPanel': 'control-panel',
                    'dropAreaInitial': 'drop-area-initial', 'dropAreaLoaded': 'drop-area-loaded',
                    'fileCount': 'file-count', 'fileNames': 'file-names', 'clearFilesBtn': 'clear-files-btn',
                    'selectAllBtn': 'select-all-btn', 'exportInfoBox': 'export-info-box',
                    'importOptionsContainer': 'import-options-container', 'specificSheetNameGroup': 'specific-sheet-name-group',
                    'specificSheetNameInput': 'specific-sheet-name-input', 'specificSheetPositionGroup': 'specific-sheet-position-group',
                    'specificSheetPositionInput': 'specific-sheet-position-input', 'selectAllTablesBtn': 'select-all-tables-btn',
                    'unselectAllTablesBtn': 'unselect-all-tables-btn', 'deleteSelectedTablesBtn': 'delete-selected-tables-btn',
                    'tableLevelControls': 'table-level-controls', 'selectedTablesInfo': 'selected-tables-info',
                    'selectedTablesList': 'selected-tables-list'
                };
                ids.forEach(id => { elements[id] = document.getElementById(mapping[id]); });
            }

            function bindEvents() {
                elements.fileInput.addEventListener('change', e => processFiles(e.target.files));
                setupDragAndDrop();
                elements.displayArea.addEventListener('change', handleDisplayAreaChange);
                
                elements.importOptionsContainer.addEventListener('change', e => {
                    if (e.target.name === 'import-mode') {
                        const selectedMode = e.target.value;
                        elements.specificSheetNameGroup.classList.toggle('hidden', selectedMode !== 'specific');
                        elements.specificSheetPositionGroup.classList.toggle('hidden', selectedMode !== 'position');
                    }
                });
                
                elements.selectAllTablesBtn.addEventListener('click', () => { selectAllTables(true); updateSelectionInfo(); });
                elements.unselectAllTablesBtn.addEventListener('click', () => { selectAllTables(false); updateSelectionInfo(); });
                elements.deleteSelectedTablesBtn.addEventListener('click', deleteSelectedTables);

                const rowSelectionButtons = [elements.selectEmptyBtn, elements.deleteSelectedBtn, elements.selectAllBtn, elements.invertSelectionBtn, elements.selectByKeywordBtn];
                rowSelectionButtons.forEach(btn => btn.addEventListener('click', () => {
                    setTimeout(() => {
                        elements.displayArea.querySelectorAll('table').forEach(syncTableCheckboxState);
                        updateSelectionInfo();
                    }, 0);
                }));
                
                elements.resetViewBtn.addEventListener('click', resetView);
                elements.exportHtmlBtn.addEventListener('click', () => exportHtml('all'));
                elements.exportSelectedBtn.addEventListener('click', () => exportHtml('selected'));
                elements.exportXlsxBtn.addEventListener('click', () => exportXlsx('all'));
                elements.exportSelectedXlsxBtn.addEventListener('click', () => exportXlsx('selected'));
                elements.exportMergedXlsxBtn.addEventListener('click', exportMergedXlsx);
                elements.showHiddenBtn.addEventListener('click', showAllHiddenElements);
                elements.clearFilesBtn.addEventListener('click', () => clearAllFiles(false));
                elements.searchInput.addEventListener('input', debounce(filterTable, 300));
            }

            function handleDisplayAreaChange(e) {
                const target = e.target;
                if (!target.matches('.table-select-checkbox, [id^="select-all-checkbox"], .row-checkbox')) return;

                let table;
                if (target.matches('.table-select-checkbox')) {
                    const wrapper = target.closest('.table-wrapper');
                    table = wrapper ? wrapper.querySelector('table') : null;
                    if (table) {
                        toggleSelectAll(target.checked, table);
                    }
                } else {
                    table = target.closest('table');
                }
                
                if (table) {
                    syncTableCheckboxState(table);
                }
                updateSelectionInfo();
            }

            function syncTableCheckboxState(table) {
                const wrapper = table.closest('.table-wrapper');
                if (!wrapper) return;
                const headerCheckbox = wrapper.querySelector('.table-select-checkbox');
                const rowCheckboxes = table.querySelectorAll('tbody tr:not(.row-hidden-search) .row-checkbox');
                
                if (rowCheckboxes.length === 0) {
                    headerCheckbox.checked = false;
                    headerCheckbox.indeterminate = false;
                    return;
                }

                const checkedCount = Array.from(rowCheckboxes).filter(cb => cb.checked).length;
                
                if (checkedCount === 0) {
                    headerCheckbox.checked = false;
                    headerCheckbox.indeterminate = false;
                } else if (checkedCount === rowCheckboxes.length) {
                    headerCheckbox.checked = true;
                    headerCheckbox.indeterminate = false;
                } else {
                    headerCheckbox.checked = false;
                    headerCheckbox.indeterminate = true;
                }
            }

            function updateSelectionInfo() {
                const selectedCheckboxes = elements.displayArea.querySelectorAll('.table-select-checkbox:checked, .table-select-checkbox:indeterminate');
                
                if (selectedCheckboxes.length > 0) {
                    const names = Array.from(selectedCheckboxes)
                        .map(cb => cb.closest('.table-header').querySelector('h4').textContent);
                    elements.selectedTablesList.textContent = names.join('; ');
                    elements.selectedTablesInfo.classList.remove('hidden');
                } else {
                    elements.selectedTablesInfo.classList.add('hidden');
                }
            }

            function setupDragAndDrop() {
                elements.dropArea.addEventListener('click', e => {
                    if (e.target.id === 'clear-files-btn' || e.target.id === 'file-input') return;
                    elements.fileInput.click();
                });
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    elements.dropArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
                });
                ['dragenter', 'dragover'].forEach(eventName => {
                    elements.dropArea.addEventListener(eventName, () => elements.dropArea.classList.add('highlight'));
                });
                ['dragleave', 'drop'].forEach(eventName => {
                    elements.dropArea.addEventListener(eventName, () => elements.dropArea.classList.remove('highlight'));
                });
                elements.dropArea.addEventListener('drop', e => processFiles(e.dataTransfer.files));
            }
            
            async function processFiles(fileList) {
                const validation = validateFiles(fileList);
                if (!validation.valid) { alert(`éŒ¯èª¤ï¼š${validation.error}`); return; }
                if (state.isProcessing) { alert('æ­£åœ¨è™•ç†æª”æ¡ˆï¼Œè«‹ç¨å€™...'); return; }

                const importMode = document.querySelector('input[name="import-mode"]:checked').value;
                const specificSheetName = elements.specificSheetNameInput.value.trim();
                const specificSheetPosition = elements.specificSheetPositionInput.value.trim();

                if (importMode === 'specific' && !specificSheetName) { alert('è«‹è¼¸å…¥æ‚¨è¦åŒ¯å…¥çš„æŒ‡å®šå·¥ä½œè¡¨åç¨±ï¼'); return; }
                if (importMode === 'position' && !specificSheetPosition) { alert('è«‹è¼¸å…¥æ‚¨è¦åŒ¯å…¥çš„æŒ‡å®šå·¥ä½œè¡¨ä½ç½®ï¼'); return; }

                state.isProcessing = true;
                elements.displayArea.innerHTML = '<div class="loading">è®€å–ä¸­ï¼Œè«‹ç¨å€™</div>';
                resetControls(true);

                // ===== BUG FIX: Correct variable declaration =====
                const tablesToRender = [];
                const missedFiles = [];
                state.loadedFiles = []; 
                
                try {
                    for (let index = 0; index < validation.files.length; index++) {
                        const file = validation.files[index];
                        elements.displayArea.innerHTML = `<div class="loading">è®€å–ä¸­ï¼Œè«‹ç¨å€™ (${index + 1}/${validation.files.length})</div>`;
                        const binaryData = await readFileAsBinary(file);
                        const workbook = XLSX.read(binaryData, { type: 'binary' });
                        const sheetNames = await getSelectedSheetNames(file.name, workbook, importMode, { name: specificSheetName, position: specificSheetPosition });

                        if ((importMode === 'specific' || importMode === 'position') && sheetNames.length === 0 && workbook.SheetNames.length > 0) {
                            missedFiles.push(file.name);
                        }
                        
                        for (const sheetName of sheetNames) {
                            const sheet = workbook.Sheets[sheetName];
                            const htmlString = XLSX.utils.sheet_to_html(sheet);
                            tablesToRender.push({ html: htmlString, filename: `${file.name} (${sheetName})` });
                            state.loadedFiles.push(`${file.name} (${sheetName})`);
                        }
                    }

                    if (missedFiles.length > 0) {
                        const criteria = importMode === 'specific' ? `åç¨±åŒ…å« "${specificSheetName}"` : `ä½ç½®ç¬¦åˆ "${specificSheetPosition}"`;
                        alert(`ä»¥ä¸‹æª”æ¡ˆæ‰¾ä¸åˆ° ${criteria} çš„å·¥ä½œè¡¨ï¼Œå·²è¢«è·³éï¼š\n\n- ${missedFiles.join('\n- ')}`);
                    }

                    state.loadedTables = tablesToRender.length;
                    renderTables(tablesToRender);
                    updateDropAreaDisplay();
                } catch (err) {
                    console.error("è™•ç†æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:", err);
                    elements.displayArea.innerHTML = `<p style="color: red;">è™•ç†æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${err.message || 'æœªçŸ¥éŒ¯èª¤'}</p>`;
                    resetControls(true);
                } finally {
                    state.isProcessing = false;
                }
            }

            function readFileAsBinary(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsBinaryString(file);
                });
            }

            function parsePositionString(str) {
                const indices = new Set();
                const parts = str.split(',').map(p => p.trim()).filter(Boolean);
                for (const part of parts) {
                    if (part.includes('-')) {
                        const [start, end] = part.split('-').map(Number);
                        if (!isNaN(start) && !isNaN(end) && start <= end) {
                            for (let i = start; i <= end; i++) indices.add(i - 1);
                        }
                    } else {
                        const num = Number(part);
                        if (!isNaN(num)) indices.add(num - 1);
                    }
                }
                return Array.from(indices).sort((a, b) => a - b);
            }
            
            async function getSelectedSheetNames(filename, workbook, mode, criteria) {
                const sheetNames = workbook.SheetNames;
                if (sheetNames.length === 0) return [];
                switch (mode) {
                    case 'all': return sheetNames;
                    case 'first': return sheetNames.length > 0 ? [sheetNames[0]] : [];
                    case 'specific': return sheetNames.filter(name => name.toLowerCase().includes(criteria.name.toLowerCase()));
                    case 'position': return parsePositionString(criteria.position).map(index => sheetNames[index]).filter(Boolean);
                    case 'manual': return await showWorksheetSelectionModal(filename, sheetNames);
                    default: return [];
                }
            }
            
            function showWorksheetSelectionModal(filename, sheetNames) {
                return new Promise(resolve => {
                    if (sheetNames.length <= 1) { resolve(sheetNames); return; }
                    const overlay = document.createElement('div');
                    overlay.className = 'modal-overlay';
                    const dialog = document.createElement('div');
                    dialog.className = 'modal-dialog';
                    dialog.innerHTML = `<div class="modal-header"><h3>é¸æ“‡å·¥ä½œè¡¨ (æ‰‹å‹•æ¨¡å¼)</h3><p>æª”æ¡ˆ "<strong>${filename}</strong>"</p></div><div class="modal-quick-actions"><button class="btn btn-primary btn-sm" id="modal-select-all">å…¨é¸</button><button class="btn btn-secondary btn-sm" id="modal-select-none">å…¨ä¸é¸</button></div><div class="modal-body"><ul class="sheet-list">${sheetNames.map(name => `<li class="sheet-item"><label><input type="checkbox" class="sheet-checkbox" value="${name}" checked> ${name}</label></li>`).join('')}</ul></div><div class="modal-footer"><button class="btn btn-secondary" id="modal-skip">è·³é</button><button class="btn btn-success" id="modal-confirm">ç¢ºèª</button></div>`;
                    overlay.appendChild(dialog);
                    document.body.appendChild(overlay);
                    const checkboxes = dialog.querySelectorAll('.sheet-checkbox');
                    const closeModal = () => document.body.removeChild(overlay);
                    dialog.querySelector('#modal-confirm').addEventListener('click', () => { resolve(Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value)); closeModal(); });
                    dialog.querySelector('#modal-skip').addEventListener('click', () => { resolve([]); closeModal(); });
                    dialog.querySelector('#modal-select-all').addEventListener('click', () => checkboxes.forEach(cb => cb.checked = true));
                    dialog.querySelector('#modal-select-none').addEventListener('click', () => checkboxes.forEach(cb => cb.checked = false));
                });
            }

            function renderTables(tablesToRender) {
                if (tablesToRender.length === 0) {
                    elements.displayArea.innerHTML = `<p>æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„å·¥ä½œè¡¨ã€‚</p>`;
                    return;
                }
                const fragment = document.createDocumentFragment();
                tablesToRender.forEach(({ html, filename }) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'table-wrapper';
                    const header = document.createElement('div');
                    header.className = 'table-header';
                    header.innerHTML = `<input type="checkbox" class="table-select-checkbox" title="é¸å–æ­¤è¡¨æ ¼"><h4>${filename}</h4>`;
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    const table = tempDiv.querySelector('table');
                    if (table) {
                        injectFilenameColumn(table, filename);
                        wrapper.appendChild(header);
                        wrapper.appendChild(table);
                        fragment.appendChild(wrapper);
                    }
                });
                elements.displayArea.innerHTML = '';
                elements.displayArea.appendChild(fragment);
                state.originalHtmlString = elements.displayArea.innerHTML;
                injectCheckboxes();
                showControls(detectHiddenElements());
            }

            function injectFilenameColumn(table, filename) {
                const th = document.createElement('th');
                th.textContent = 'Source File';
                th.classList.add('filename-cell');
                table.querySelector('thead tr')?.prepend(th);
                table.querySelectorAll('tbody tr').forEach(row => {
                    const td = document.createElement('td');
                    td.textContent = filename;
                    td.classList.add('filename-cell');
                    row.prepend(td);
                });
            }

            function injectCheckboxes() {
                elements.displayArea.querySelectorAll('thead tr').forEach((headRow, index) => {
                    const th = document.createElement('th');
                    th.innerHTML = `<input type="checkbox" id="select-all-checkbox-${index}" title="å…¨é¸/å…¨ä¸é¸">`;
                    th.classList.add('checkbox-cell');
                    headRow.prepend(th);
                });
                elements.displayArea.querySelectorAll('tbody tr').forEach(row => {
                    const td = document.createElement('td');
                    td.innerHTML = '<input type="checkbox" class="row-checkbox">';
                    td.classList.add('checkbox-cell');
                    row.prepend(td);
                });
            }

            function toggleSelectAll(isChecked, table) {
                if (!table) return;
                table.querySelectorAll('tbody tr:not(.row-hidden-search) .row-checkbox').forEach(cb => cb.checked = isChecked);
            }

            function detectHiddenElements() {
                return elements.displayArea.querySelectorAll('tr[style*="display: none"], td[style*="display: none"], th[style*="display: none"]').length;
            }

            function showAllHiddenElements() {
                const hidden = elements.displayArea.querySelectorAll('tr[style*="display: none"], td[style*="display: none"], th[style*="display: none"]');
                if (hidden.length === 0) { alert('æ²’æœ‰éœ€è¦é¡¯ç¤ºçš„éš±è—è¡Œåˆ—ã€‚'); return; }
                hidden.forEach(el => el.style.display = '');
                alert(`å·²é¡¯ç¤º ${hidden.length} å€‹éš±è—çš„è¡Œåˆ—ã€‚`);
                elements.showHiddenBtn.classList.add('hidden');
                elements.loadStatusMessage.classList.add('hidden');
            }

            function selectAllTables(isChecked) {
                elements.displayArea.querySelectorAll('.table-select-checkbox').forEach(cb => {
                    if (cb.checked !== isChecked) {
                        cb.click();
                    }
                });
            }

            function deleteSelectedTables() {
                const selectedWrappers = Array.from(elements.displayArea.querySelectorAll('.table-select-checkbox:checked')).map(cb => cb.closest('.table-wrapper'));
                if (selectedWrappers.length === 0) { alert('è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„è¡¨æ ¼ã€‚'); return; }
                if (confirm(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ ${selectedWrappers.length} å€‹é¸å®šçš„è¡¨æ ¼å—ï¼Ÿ`)) {
                    selectedWrappers.forEach(wrapper => wrapper.remove());
                    updateFileStateAfterDeletion();
                }
            }
            
            function updateFileStateAfterDeletion() {
                const remainingWrappers = elements.displayArea.querySelectorAll('.table-wrapper');
                state.loadedTables = remainingWrappers.length;
                state.loadedFiles = Array.from(remainingWrappers).map(w => w.querySelector('h4').textContent);
                if (state.loadedTables === 0) {
                    clearAllFiles(true);
                } else {
                    updateDropAreaDisplay();
                }
            }

            function selectByKeyword() {
                const keywordInput = elements.selectKeywordInput.value.trim();
                const isRegex = elements.selectKeywordRegex.checked;
                if (!keywordInput) { alert('è«‹å…ˆè¼¸å…¥é—œéµå­—'); return; }
                let matchLogic;
                try {
                    if (isRegex) { const regex = new RegExp(keywordInput, 'i'); matchLogic = text => regex.test(text); }
                    else if (keywordInput.includes(',')) { const keywords = keywordInput.split(',').map(k => k.trim().toLowerCase()).filter(Boolean); matchLogic = text => keywords.some(k => text.includes(k)); }
                    else { const keywords = keywordInput.split(/\s+/).map(k => k.trim().toLowerCase()).filter(Boolean); matchLogic = text => keywords.every(k => text.includes(k)); }
                } catch (e) { alert('ç„¡æ•ˆçš„ Regex è¡¨ç¤ºå¼ï¼š\n' + e.message); return; }
                let count = 0;
                elements.displayArea.querySelectorAll('tbody tr:not(.row-hidden-search)').forEach(row => {
                    if (matchLogic(Array.from(row.cells).slice(2).map(c => c.textContent).join(' '))) {
                        row.querySelector('.row-checkbox').checked = true;
                        count++;
                    }
                });
                alert(count > 0 ? `å·²å‹¾é¸ ${count} å€‹ç¬¦åˆæ¢ä»¶çš„åˆ—` : `æœªæ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„åˆ—`);
            }

            function selectEmptyRows() {
                let count = 0;
                elements.displayArea.querySelectorAll('tbody tr:not(.row-hidden-search)').forEach(row => {
                    if (Array.from(row.cells).slice(2).every(c => c.textContent.trim() === '')) {
                        row.querySelector('.row-checkbox').checked = true;
                        count++;
                    }
                });
                if (count === 0) alert('æœªæ‰¾åˆ°ç©ºç™½åˆ—');
            }

            function selectAllRows() {
                const rows = elements.displayArea.querySelectorAll('tbody tr:not(.row-hidden-search)');
                if (rows.length === 0) { alert('æ²’æœ‰å¯å‹¾é¸çš„åˆ—'); return; }
                rows.forEach(row => row.querySelector('.row-checkbox').checked = true);
                elements.displayArea.querySelectorAll('[id^="select-all-checkbox"]').forEach(cb => cb.checked = true);
            }

            function invertSelection() {
                elements.displayArea.querySelectorAll('tbody tr:not(.row-hidden-search) .row-checkbox').forEach(cb => cb.checked = !cb.checked);
            }

            function deleteSelectedRows() {
                const selected = elements.displayArea.querySelectorAll('.row-checkbox:checked');
                if (selected.length === 0) { alert('è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„åˆ—'); return; }
                if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${selected.length} ç­†è³‡æ–™åˆ—å—ï¼Ÿ`)) {
                    selected.forEach(cb => cb.closest('tr').remove());
                }
            }

            function filterTable() {
                const keywords = elements.searchInput.value.toLowerCase().trim().split(/\s+/).filter(Boolean);
                elements.displayArea.querySelectorAll('.table-wrapper').forEach(wrapper => {
                    let visibleRowCount = 0;
                    wrapper.querySelectorAll('tbody tr').forEach(row => {
                        const text = Array.from(row.cells).slice(2).map(c => c.textContent).join(' ').toLowerCase();
                        const isVisible = keywords.every(k => text.includes(k));
                        row.classList.toggle('row-hidden-search', !isVisible);
                        if (isVisible) visibleRowCount++;
                    });
                    wrapper.style.display = visibleRowCount > 0 ? '' : 'none';
                });
                elements.displayArea.querySelectorAll('table').forEach(syncTableCheckboxState);
                updateSelectionInfo();
            }

            function resetView() {
                if (!state.originalHtmlString) return;
                elements.displayArea.innerHTML = state.originalHtmlString;
                injectCheckboxes();
                ['searchInput', 'selectKeywordInput'].forEach(id => elements[id].value = '');
                elements.selectKeywordRegex.checked = false;
                filterTable();
                elements.loadStatusMessage.classList.add('hidden');
                const hiddenCount = detectHiddenElements();
                if (hiddenCount > 0) {
                    elements.loadStatusMessage.textContent = `æ³¨æ„ï¼šå·²é‡è¨­è¡¨æ ¼ï¼Œ${hiddenCount} å€‹éš±è—çš„è¡Œåˆ—å·²é‚„åŸã€‚`;
                    elements.loadStatusMessage.classList.remove('hidden');
                    elements.showHiddenBtn.classList.remove('hidden');
                }
                updateSelectionInfo();
            }

            function resetControls(isNewFile) {
                if (!isNewFile) return;
                state.originalHtmlString = '';
                ['searchInput', 'selectKeywordInput'].forEach(id => elements[id].value = '');
                elements.selectKeywordRegex.checked = false;
                elements.controlPanel.classList.add('hidden');
                updateSelectionInfo();
            }

            function updateDropAreaDisplay() {
                const hasFiles = state.loadedTables > 0;
                elements.dropArea.classList.toggle('compact', hasFiles);
                elements.dropAreaInitial.classList.toggle('hidden', hasFiles);
                elements.dropAreaLoaded.classList.toggle('hidden', !hasFiles);
                elements.importOptionsContainer.classList.toggle('hidden', hasFiles);
                if (hasFiles) {
                    elements.fileCount.textContent = state.loadedTables;
                    const names = state.loadedFiles.slice(0, 3).join(', ');
                    const more = state.loadedFiles.length > 3 ? ` åŠå…¶ä»– ${state.loadedFiles.length - 3} å€‹...` : '';
                    elements.fileNames.textContent = names + more;
                }
            }

            function clearAllFiles(silent = false) {
                if (!silent && !confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å·²è¼‰å…¥çš„æª”æ¡ˆå—ï¼Ÿ')) return;
                state.originalHtmlString = '';
                state.loadedFiles = [];
                state.loadedTables = 0;
                elements.displayArea.innerHTML = '';
                elements.fileInput.value = '';
                ['specificSheetNameInput', 'specificSheetPositionInput'].forEach(id => elements[id].value = '');
                updateDropAreaDisplay();
                resetControls(true);
            }

            function showControls(hiddenCount) {
                elements.controlPanel.classList.remove('hidden');
                ['selectByKeywordGroup', 'selectByKeywordBtn', 'selectEmptyBtn', 'deleteSelectedBtn', 'invertSelectionBtn', 
                 'exportHtmlBtn', 'selectAllBtn', 'exportSelectedBtn', 'exportXlsxBtn', 'exportSelectedXlsxBtn', 
                 'exportMergedXlsxBtn', 'resetViewBtn', 'exportInfoBox', 'tableLevelControls']
                .forEach(id => elements[id]?.classList.remove('hidden'));
                
                if (hiddenCount > 0) {
                    elements.loadStatusMessage.textContent = `æ³¨æ„ï¼šæª”æ¡ˆä¸­åŒ…å« ${hiddenCount} å€‹è¢«éš±è—çš„è¡Œåˆ—ã€‚`;
                    elements.loadStatusMessage.classList.remove('hidden');
                    elements.showHiddenBtn.classList.remove('hidden');
                }
            }
            
            function validateFiles(fileList) {
                if (!fileList || fileList.length === 0) return { valid: false, error: 'æ²’æœ‰é¸æ“‡æª”æ¡ˆ' };
                const validFiles = Array.from(fileList).filter(file => CONSTANTS.VALID_FILE_EXTENSIONS.some(ext => file.name.toLowerCase().endsWith(ext)));
                if (validFiles.length === 0) return { valid: false, error: 'è«‹ä¸Šå‚³ .xls æˆ– .xlsx æ ¼å¼çš„æª”æ¡ˆ' };
                return { valid: true, files: validFiles };
            }

            // Dummy export functions to avoid breaking the code, you can fill them with your actual implementation
            function exportHtml(mode) { console.log('Exporting HTML:', mode); alert('HTML åŒ¯å‡ºåŠŸèƒ½å¾…å¯¦ç¾ã€‚'); }
            function exportXlsx(mode) { console.log('Exporting XLSX:', mode); alert('XLSX åŒ¯å‡ºåŠŸèƒ½å¾…å¯¦ç¾ã€‚'); }
            function exportMergedXlsx() { console.log('Exporting Merged XLSX'); alert('åˆä½µåŒ¯å‡º XLSX åŠŸèƒ½å¾…å¯¦ç¾ã€‚'); }

            return { init };
        })();

        ExcelViewer.init();
    </script>
</body>
</html>
