<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel æª¢è¦–å™¨ - å¤šæª”æ¡ˆæ•´åˆå·¥å…·</title>
    
    <!-- SheetJS Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .content {
            padding: 30px;
        }

        /* æ‹–æ”¾å€åŸŸ - åˆå§‹ç‹€æ…‹ */
        #drop-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 60px 20px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }

        #drop-area.compact {
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            text-align: left;
        }

        #drop-area:hover, #drop-area.highlight {
            background: #e9ecef;
            border-color: #764ba2;
            transform: translateY(-2px);
        }

        #drop-area h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        #drop-area.compact h3 {
            margin-bottom: 0;
            font-size: 1.1rem;
        }

        #drop-area p {
            color: #6c757d;
            margin-bottom: 20px;
        }

        #drop-area.compact p {
            margin-bottom: 0;
            font-size: 0.9rem;
        }

        #file-input {
            display: none;
        }

        .btn-upload {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* æª”æ¡ˆè³‡è¨Šå€ */
        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .file-info-text {
            flex: 1;
        }

        .file-count {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .btn-clear {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-clear:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        /* æ§åˆ¶é¢æ¿ */
        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .control-group input[type="text"] {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .control-group input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-label {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            font-weight: normal;
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }

        /* æŒ‰éˆ•çµ„ */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .hidden {
            display: none !important;
        }

        /* ç‹€æ…‹è¨Šæ¯ */
        .status-message {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #856404;
        }

        /* è¡¨æ ¼æ¨£å¼ */
        #excel-display-area {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        table th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        table tbody tr:hover {
            background: #f8f9fa;
        }

        .checkbox-cell {
            width: 50px;
            text-align: center;
        }

        .checkbox-cell input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .filename-cell {
            background-color: #e9ecef;
            font-size: 0.9em;
            color: #495057;
            font-weight: 500;
        }

        .row-hidden-search {
            display: none;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            table {
                font-size: 0.85rem;
            }

            table th, table td {
                padding: 8px;
            }
        }

        /* è¼‰å…¥å‹•ç•« */
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2rem;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Excel æª¢è¦–å™¨</h1>
            <p>æ”¯æ´å¤šæª”æ¡ˆã€å¤šå·¥ä½œè¡¨æ•´åˆ | å¼·å¤§çš„ç¯©é¸èˆ‡åŒ¯å‡ºåŠŸèƒ½</p>
        </div>

        <div class="content">
            <!-- æ‹–æ”¾ä¸Šå‚³å€ -->
            <div id="drop-area">
                <input type="file" id="file-input" accept=".xls,.xlsx" multiple>
                <div id="drop-area-initial">
                    <h3>ğŸ“ æ‹–æ”¾æª”æ¡ˆåˆ°æ­¤è™•</h3>
                    <p>æˆ–é»æ“Šä¸‹æ–¹æŒ‰éˆ•é¸æ“‡æª”æ¡ˆ</p>
                    <button class="btn-upload" onclick="document.getElementById('file-input').click()">
                        é¸æ“‡ Excel æª”æ¡ˆ
                    </button>
                </div>
                <div id="drop-area-loaded" class="hidden">
                    <div class="file-info">
                        <div class="file-info-text">
                            <h3>ğŸ“Š å·²è¼‰å…¥æª”æ¡ˆ <span class="file-count" id="file-count">0</span></h3>
                            <p id="file-names">-</p>
                        </div>
                        <button class="btn-clear" id="clear-files-btn">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æª”æ¡ˆ</button>
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="controls hidden" id="control-panel">
                <!-- æœå°‹ç¯©é¸ -->
                <div class="control-group">
                    <label for="search-input">ğŸ” å³æ™‚æœå°‹ç¯©é¸ï¼ˆæ”¯æ´å¤šé—œéµå­— AND æœå°‹ï¼‰</label>
                    <input type="text" id="search-input" placeholder="è¼¸å…¥é—œéµå­—ä»¥ç¯©é¸è³‡æ–™åˆ—...">
                </div>

                <!-- é—œéµå­—å‹¾é¸ -->
                <div class="control-group hidden" id="select-by-keyword-group">
                    <label for="select-keyword-input">âœ… ä¾é—œéµå­—å‹¾é¸è³‡æ–™åˆ—</label>
                    <input type="text" id="select-keyword-input" 
                           placeholder="å¤šé—œéµå­—ç”¨ç©ºæ ¼(AND)æˆ–é€—è™Ÿ(OR)åˆ†éš”ï¼Œæˆ–ä½¿ç”¨ Regex">
                    <label class="checkbox-label">
                        <input type="checkbox" id="select-keyword-regex">
                        ä½¿ç”¨æ­£è¦è¡¨ç¤ºå¼ (Regex)
                    </label>
                </div>

                <!-- æŒ‰éˆ•çµ„ -->
                <div class="button-group">
                    <button class="btn btn-primary hidden" id="select-by-keyword-btn">
                        ä¾é—œéµå­—å‹¾é¸
                    </button>
                    <button class="btn btn-primary hidden" id="select-empty-btn">
                        å‹¾é¸ç©ºç™½åˆ—
                    </button>
                    <button class="btn btn-warning hidden" id="invert-selection-btn">
                        åå‘é¸å–
                    </button>
                    <button class="btn btn-danger hidden" id="delete-selected-btn">
                        åˆªé™¤å‹¾é¸åˆ—
                    </button>
                    <button class="btn btn-info hidden" id="show-hidden-btn">
                        é¡¯ç¤ºéš±è—çš„è¡Œåˆ—
                    </button>
                    <button class="btn btn-success hidden" id="export-html-btn">
                        åŒ¯å‡º HTML (å…¨éƒ¨)
                    </button>
                    <button class="btn btn-success hidden" id="export-selected-btn">
                        åŒ¯å‡º HTML (é¸å–)
                    </button>
                    <button class="btn btn-success hidden" id="export-xlsx-btn">
                        åŒ¯å‡ºå…¨éƒ¨ç‚ºXLSX(æŒ‰å·¥ä½œè¡¨åˆ†åˆ—)
                    </button>
                    <button class="btn btn-success hidden" id="export-selected-xlsx-btn">
                        åŒ¯å‡ºé¸å–åˆ—ç‚ºXLSX(æŒ‰å·¥ä½œè¡¨åˆ†åˆ—)
                    </button>
                    <button class="btn btn-success hidden" id="export-merged-xlsx-btn">
                        åˆä½µæ‰€æœ‰è¡¨æ ¼ç‚ºå–®ä¸€å·¥ä½œè¡¨
                    </button>
                    <button class="btn btn-secondary hidden" id="reset-view-btn">
                        é‚„åŸåˆå§‹ç‹€æ…‹
                    </button>
                </div>
            </div>

            <!-- ç‹€æ…‹è¨Šæ¯ -->
            <div class="status-message hidden" id="load-status-message"></div>

            <!-- è¡¨æ ¼é¡¯ç¤ºå€ -->
            <div id="excel-display-area"></div>
        </div>
    </div>

    <script>
        const ExcelViewer = (() => {
            'use strict';

            const CONSTANTS = {
                CHECKBOX_COLUMN_INDEX: 0,
                FILENAME_COLUMN_INDEX: 1,
                DATA_START_INDEX: 2,
                VALID_FILE_EXTENSIONS: ['.xls', '.xlsx']
            };

            const state = {
                originalHtmlString: '',
                isProcessing: false,
                loadedFiles: [],
                loadedTables: 0
            };

            const elements = {};

            function init() {
                cacheElements();
                bindEvents();
            }

            function cacheElements() {
                const ids = [
                    'fileInput', 'displayArea', 'searchInput', 'dropArea',
                    'deleteSelectedBtn', 'invertSelectionBtn', 'resetViewBtn',
                    'selectEmptyBtn', 'exportHtmlBtn', 'showHiddenBtn',
                    'exportSelectedBtn', 'exportXlsxBtn', 'exportSelectedXlsxBtn',
                    'exportMergedXlsxBtn', 'selectByKeywordGroup', 'selectKeywordInput',
                    'selectByKeywordBtn', 'selectKeywordRegex', 'loadStatusMessage', 'controlPanel',
                    'dropAreaInitial', 'dropAreaLoaded', 'fileCount', 'fileNames', 'clearFilesBtn'
                ];

                const mapping = {
                    'fileInput': 'file-input',
                    'displayArea': 'excel-display-area',
                    'searchInput': 'search-input',
                    'dropArea': 'drop-area',
                    'deleteSelectedBtn': 'delete-selected-btn',
                    'invertSelectionBtn': 'invert-selection-btn',
                    'resetViewBtn': 'reset-view-btn',
                    'selectEmptyBtn': 'select-empty-btn',
                    'exportHtmlBtn': 'export-html-btn',
                    'showHiddenBtn': 'show-hidden-btn',
                    'exportSelectedBtn': 'export-selected-btn',
                    'exportXlsxBtn': 'export-xlsx-btn',
                    'exportSelectedXlsxBtn': 'export-selected-xlsx-btn',
                    'exportMergedXlsxBtn': 'export-merged-xlsx-btn',
                    'selectByKeywordGroup': 'select-by-keyword-group',
                    'selectKeywordInput': 'select-keyword-input',
                    'selectByKeywordBtn': 'select-by-keyword-btn',
                    'selectKeywordRegex': 'select-keyword-regex',
                    'loadStatusMessage': 'load-status-message',
                    'controlPanel': 'control-panel',
                    'dropAreaInitial': 'drop-area-initial',
                    'dropAreaLoaded': 'drop-area-loaded',
                    'fileCount': 'file-count',
                    'fileNames': 'file-names',
                    'clearFilesBtn': 'clear-files-btn'
                };

                ids.forEach(id => {
                    elements[id] = document.getElementById(mapping[id]);
                });
            }

            function bindEvents() {
                elements.fileInput.addEventListener('change', e => processFiles(e.target.files));
                setupDragAndDrop();
                elements.displayArea.addEventListener('change', handleDisplayAreaChange);
                
                elements.selectEmptyBtn.addEventListener('click', selectEmptyRows);
                elements.deleteSelectedBtn.addEventListener('click', deleteSelectedRows);
                elements.invertSelectionBtn.addEventListener('click', invertSelection);
                elements.resetViewBtn.addEventListener('click', resetView);
                elements.selectByKeywordBtn.addEventListener('click', selectByKeyword);
                elements.exportHtmlBtn.addEventListener('click', () => exportHtml('all'));
                elements.exportSelectedBtn.addEventListener('click', () => exportHtml('selected'));
                elements.exportXlsxBtn.addEventListener('click', () => exportXlsx('all'));
                elements.exportSelectedXlsxBtn.addEventListener('click', () => exportXlsx('selected'));
                elements.exportMergedXlsxBtn.addEventListener('click', exportMergedXlsx);
                elements.showHiddenBtn.addEventListener('click', showAllHiddenElements);
                elements.clearFilesBtn.addEventListener('click', clearAllFiles);
                elements.searchInput.addEventListener('input', debounce(filterTable, 300));
            }

            function setupDragAndDrop() {
                elements.dropArea.addEventListener('click', e => {
                    if (e.target.id !== 'file-input') elements.fileInput.click();
                });

                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    elements.dropArea.addEventListener(eventName, e => {
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    elements.dropArea.addEventListener(eventName, () => {
                        elements.dropArea.classList.add('highlight');
                    });
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    elements.dropArea.addEventListener(eventName, () => {
                        elements.dropArea.classList.remove('highlight');
                    });
                });

                elements.dropArea.addEventListener('drop', e => processFiles(e.dataTransfer.files));
            }

            function handleDisplayAreaChange(e) {
                if (e.target.matches('[id^="select-all-checkbox"]')) {
                    const table = e.target.closest('table');
                    toggleSelectAll(e.target.checked, table);
                }
            }

            function debounce(func, wait) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func(...args), wait);
                };
            }

            function readFileAsBinary(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsBinaryString(file);
                });
            }

            function uncheckAllSelectAllCheckboxes() {
                elements.displayArea.querySelectorAll('[id^="select-all-checkbox"]')
                    .forEach(cb => cb.checked = false);
            }

            function getDataCellsText(row, toLowerCase = true) {
                let text = '';
                for (let i = CONSTANTS.DATA_START_INDEX; i < row.cells.length; i++) {
                    text += toLowerCase ? row.cells[i].textContent.toLowerCase() : row.cells[i].textContent;
                }
                return text;
            }

            function getCurrentDateString() {
                return new Date().toISOString().slice(0, 10);
            }

            function validateFiles(fileList) {
                if (!fileList || fileList.length === 0) {
                    return { valid: false, error: 'æ²’æœ‰é¸æ“‡æª”æ¡ˆ' };
                }

                const validFiles = Array.from(fileList).filter(file => {
                    const fileName = file.name.toLowerCase();
                    return CONSTANTS.VALID_FILE_EXTENSIONS.some(ext => fileName.endsWith(ext));
                });

                if (validFiles.length === 0) {
                    return { valid: false, error: 'è«‹ä¸Šå‚³ .xls æˆ– .xlsx æ ¼å¼çš„ Excel æª”æ¡ˆï¼' };
                }

                return { valid: true, files: validFiles };
            }

            async function processFiles(fileList) {
                const validation = validateFiles(fileList);
                if (!validation.valid) {
                    alert(`éŒ¯èª¤ï¼š${validation.error}`);
                    return;
                }

                if (state.isProcessing) {
                    alert('æ­£åœ¨è™•ç†æª”æ¡ˆï¼Œè«‹ç¨å€™...');
                    return;
                }

                state.isProcessing = true;
                elements.displayArea.innerHTML = '<div class="loading">è®€å–ä¸­ï¼Œè«‹ç¨å€™</div>';
                resetControls(true);

                const tablesToRender = [];
                state.loadedFiles = [];

                try {
                    for (let index = 0; index < validation.files.length; index++) {
                        const file = validation.files[index];
                        elements.displayArea.innerHTML = 
                            `<div class="loading">è®€å–ä¸­ï¼Œè«‹ç¨å€™ (${index + 1}/${validation.files.length})</div>`;

                        const binaryData = await readFileAsBinary(file);
                        const workbook = XLSX.read(binaryData, { type: 'binary' });
                        const selectedSheets = await selectWorksheets(file.name, workbook.SheetNames);

                        for (const sheetName of selectedSheets) {
                            const sheet = workbook.Sheets[sheetName];
                            const htmlString = XLSX.utils.sheet_to_html(sheet);
                            tablesToRender.push({
                                html: htmlString,
                                filename: `${file.name} (${sheetName})`
                            });
                            state.loadedFiles.push(`${file.name} (${sheetName})`);
                        }
                    }

                    state.loadedTables = tablesToRender.length;
                    renderTables(tablesToRender);
                    updateDropAreaDisplay();
                } catch (err) {
                    console.error("è™•ç†æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:", err);
                    elements.displayArea.innerHTML = 
                        `<p style="color: red;">è™•ç†æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${err.message || 'æœªçŸ¥éŒ¯èª¤'}</p>`;
                    resetControls(true);
                } finally {
                    state.isProcessing = false;
                }
            }

            async function selectWorksheets(filename, sheetNames) {
                if (sheetNames.length === 1) return [sheetNames[0]];

                const promptMessage = 
                    `æª”æ¡ˆ "${filename}" åŒ…å«å¤šå€‹å·¥ä½œè¡¨ï¼š\n\n` +
                    sheetNames.map((name, i) => `${i + 1}: ${name}`).join('\n') +
                    '\n\nè«‹è¼¸å…¥æ‚¨è¦åŒ¯å…¥çš„å·¥ä½œè¡¨ç·¨è™Ÿ(å¯å¤šé¸ï¼Œç”¨é€—è™Ÿåˆ†éš”)ï¼Œä¾‹å¦‚: 1,3\n(ç•™ç™½å‰‡è·³éæ­¤æª”æ¡ˆ)';
                
                const choices = prompt(promptMessage);
                if (!choices) return [];

                return choices.split(',')
                    .map(s => sheetNames[parseInt(s.trim()) - 1])
                    .filter(Boolean);
            }

            function renderTables(tablesToRender) {
                if (tablesToRender.length === 0) {
                    elements.displayArea.innerHTML = '<p>æ²’æœ‰é¸æ“‡ä»»ä½•å·¥ä½œè¡¨ï¼Œè«‹é‡æ–°ä¸Šå‚³æª”æ¡ˆã€‚</p>';
                    return;
                }

                const fragment = document.createDocumentFragment();
                for (const tableData of tablesToRender) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = tableData.html;
                    const table = tempDiv.querySelector('table');
                    if (table) {
                        injectFilenameColumn(table, tableData.filename);
                        fragment.appendChild(table);
                    }
                }

                elements.displayArea.innerHTML = '';
                elements.displayArea.appendChild(fragment);
                state.originalHtmlString = elements.displayArea.innerHTML;
                injectCheckboxes();
                
                const hiddenCount = detectHiddenElements();
                showControls(hiddenCount);
            }

            function injectFilenameColumn(tableElement, filename) {
                const th = document.createElement('th');
                th.textContent = 'Source File';
                th.classList.add('filename-cell');
                tableElement.querySelector('thead tr')?.prepend(th);

                const rows = tableElement.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const td = document.createElement('td');
                    td.textContent = filename;
                    td.classList.add('filename-cell');
                    row.prepend(td);
                });
            }

            function injectCheckboxes() {
                const headRows = elements.displayArea.querySelectorAll('thead tr');
                headRows.forEach((headRow, index) => {
                    const selectAllTh = document.createElement('th');
                    selectAllTh.innerHTML = 
                        `<input type="checkbox" id="select-all-checkbox-${index}" title="å…¨é¸/å…¨ä¸é¸">`;
                    selectAllTh.classList.add('checkbox-cell');
                    headRow.prepend(selectAllTh);
                });

                const bodyRows = elements.displayArea.querySelectorAll('tbody tr');
                bodyRows.forEach(row => {
                    const checkCell = document.createElement('td');
                    checkCell.innerHTML = '<input type="checkbox" class="row-checkbox">';
                    checkCell.classList.add('checkbox-cell');
                    row.prepend(checkCell);
                });
            }

            function toggleSelectAll(isChecked, table) {
                if (!table) return;
                const visibleRows = table.querySelectorAll('tbody tr:not(.row-hidden-search)');
                visibleRows.forEach(row => {
                    const checkbox = row.querySelector('.row-checkbox');
                    if (checkbox) checkbox.checked = isChecked;
                });
            }

            function detectHiddenElements() {
                const selector = 'tr[style*="display: none"], td[style*="display: none"], th[style*="display: none"]';
                return elements.displayArea.querySelectorAll(selector).length;
            }

            function showAllHiddenElements() {
                const selector = 'tr[style*="display: none"], td[style*="display: none"], th[style*="display: none"]';
                const hiddenElements = elements.displayArea.querySelectorAll(selector);
                if (hiddenElements.length === 0) {
                    alert('æ²’æœ‰éœ€è¦é¡¯ç¤ºçš„éš±è—è¡Œåˆ—ã€‚');
                    return;
                }
                hiddenElements.forEach(el => el.style.display = '');
                alert(`å·²é¡¯ç¤º ${hiddenElements.length} å€‹éš±è—çš„è¡Œåˆ—ã€‚`);
                elements.showHiddenBtn.classList.add('hidden');
                elements.loadStatusMessage.classList.add('hidden');
            }

            function selectByKeyword() {
                const keywordInput = elements.selectKeywordInput.value.trim();
                const isRegex = elements.selectKeywordRegex.checked;

                if (keywordInput === '') {
                    alert('è«‹å…ˆè¼¸å…¥è¦å‹¾é¸çš„é—œéµå­—ã€‚');
                    return;
                }

                let matchLogic;
                try {
                    if (isRegex) {
                        const regex = new RegExp(keywordInput, 'i');
                        matchLogic = cellText => regex.test(cellText);
                    } else if (keywordInput.includes(',')) {
                        const keywords = keywordInput.split(',').map(k => k.trim().toLowerCase()).filter(k => k);
                        matchLogic = cellText => keywords.some(k => cellText.includes(k));
                    } else {
                        const keywords = keywordInput.split(/\s+/).map(k => k.trim().toLowerCase()).filter(k => k);
                        matchLogic = cellText => keywords.every(k => cellText.includes(k));
                    }
                } catch (e) {
                    alert('ç„¡æ•ˆçš„ Regex è¡¨ç¤ºå¼ï¼š\n' + e.message);
                    return;
                }

                const rows = elements.displayArea.querySelectorAll('tbody tr:not(.row-hidden-search)');
                let count = 0;
                rows.forEach(row => {
                    const cellText = getDataCellsText(row, !isRegex);
                    if (matchLogic(cellText)) {
                        const cb = row.querySelector('.row-checkbox');
                        if (cb) {
                            cb.checked = true;
                            count++;
                        }
                    }
                });

                if (count === 0) {
                    alert(`åœ¨å¯è¦‹çš„è³‡æ–™åˆ—ä¸­ï¼Œæ²’æœ‰æ‰¾åˆ°ç¬¦åˆ "${keywordInput}" çš„åˆ—ã€‚`);
                } else {
                    alert(`å·²å‹¾é¸ ${count} å€‹ç¬¦åˆ "${keywordInput}" çš„è³‡æ–™åˆ—ã€‚`);
                    uncheckAllSelectAllCheckboxes();
                }
            }

            function selectEmptyRows() {
                const rows = elements.displayArea.querySelectorAll('tbody tr:not(.row-hidden-search)');
                let count = 0;
                rows.forEach(row => {
                    const dataCellText = getDataCellsText(row).trim();
                    if (dataCellText === '') {
                        const cb = row.querySelector('.row-checkbox');
                        if (cb) {
                            cb.checked = true;
                            count++;
                        }
                    }
                });

                if (count === 0) {
                    alert('åœ¨å¯è¦‹çš„è³‡æ–™åˆ—ä¸­ï¼Œæ²’æœ‰æ‰¾åˆ°å®Œå…¨ç©ºç™½çš„åˆ—ã€‚');
                } else {
                    uncheckAllSelectAllCheckboxes();
                }
            }

            function invertSelection() {
                const rows = elements.displayArea.querySelectorAll('tbody tr:not(.row-hidden-search)');
                rows.forEach(row => {
                    const cb = row.querySelector('.row-checkbox');
                    if (cb) cb.checked = !cb.checked;
                });
                uncheckAllSelectAllCheckboxes();
            }

            function deleteSelectedRows() {
                const selectedCheckboxes = elements.displayArea.querySelectorAll('.row-checkbox:checked');
                if (selectedCheckboxes.length === 0) {
                    alert('è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„è³‡æ–™åˆ—ã€‚');
                    return;
                }
                if (confirm(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ ${selectedCheckboxes.length} ç­†å‹¾é¸çš„è³‡æ–™åˆ—å—ï¼Ÿ`)) {
                    selectedCheckboxes.forEach(cb => cb.closest('tr').remove());
                    uncheckAllSelectAllCheckboxes();
                }
            }

            function filterTable() {
                const searchTerm = elements.searchInput.value.toLowerCase().trim();
                const keywords = searchTerm.split(/\s+/).filter(k => k.length > 0);
                const rows = elements.displayArea.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cellText = getDataCellsText(row, true);
                    const matchesAll = keywords.every(k => cellText.includes(k));
                    row.classList.toggle('row-hidden-search', !matchesAll);
                });
                uncheckAllSelectAllCheckboxes();
            }

            function exportHtml(mode) {
                const tables = elements.displayArea.querySelectorAll('table');
                if (tables.length === 0) {
                    alert('æ²’æœ‰å¯åŒ¯å‡ºçš„è¡¨æ ¼ã€‚');
                    return;
                }

                let combinedCleanedHtml = '';
                if (mode === 'all') {
                    combinedCleanedHtml = exportAllTables(tables);
                } else if (mode === 'selected') {
                    const selectedCheckboxes = elements.displayArea.querySelectorAll('.row-checkbox:checked');
                    if (selectedCheckboxes.length === 0) {
                        alert('è«‹å…ˆå‹¾é¸è¦åŒ¯å‡ºçš„è³‡æ–™åˆ—ã€‚');
                        return;
                    }
                    combinedCleanedHtml = exportSelectedTables(tables);
                }

                if (combinedCleanedHtml === '') {
                    alert('æ²’æœ‰æ‰¾åˆ°å¯åŒ¯å‡ºçš„å…§å®¹ã€‚');
                    return;
                }

                const title = mode === 'all' ? 'åŒ¯å‡ºå ±è¡¨ (å…¨éƒ¨)' : 'åŒ¯å‡ºå ±è¡¨ (é¸å–é …ç›®)';
                const filename = `report_${mode}_${getCurrentDateString()}.html`;
                const htmlContent = generateExportHtml(combinedCleanedHtml, title);
                downloadHtml(htmlContent, filename);
            }

            function exportAllTables(tables) {
                let html = '';
                tables.forEach(table => {
                    const tableClone = table.cloneNode(true);
                    tableClone.querySelectorAll('.checkbox-cell').forEach(cell => cell.remove());
                    tableClone.querySelectorAll('tr.row-hidden-search')
                        .forEach(row => row.classList.remove('row-hidden-search'));
                    html += tableClone.outerHTML + '<br><hr><br>';
                });
                return html;
            }

            function exportSelectedTables(tables) {
                let html = '';
                tables.forEach(table => {
                    const selectedRows = table.querySelectorAll('tbody .row-checkbox:checked');
                    if (selectedRows.length > 0) {
                        const headerClone = table.querySelector('thead').cloneNode(true);
                        headerClone.querySelector('.checkbox-cell')?.remove();
                        let selectedRowsHtml = '';
                        selectedRows.forEach(cb => {
                            const rowClone = cb.closest('tr').cloneNode(true);
                            rowClone.querySelector('.checkbox-cell')?.remove();
                            rowClone.classList.remove('row-hidden-search');
                            selectedRowsHtml += rowClone.outerHTML;
                        });
                        html += '<table>' + headerClone.outerHTML + 
                                '<tbody>' + selectedRowsHtml + '</tbody></table><br><hr><br>';
                    }
                });
                return html;
            }

            function generateExportHtml(htmlContent, title) {
                return `<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>åŒ¯å‡ºå ±è¡¨ - ${new Date().toLocaleString()}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 20px; line-height: 1.6; }
        table { border-collapse: collapse; width: 100%; border: 1px solid #ccc; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        .filename-cell { background-color: #f8f9f9; font-size: 0.9em; color: #555; }
    </style>
</head>
<body>
    <h1>${title}</h1>
    <p>ç”¢ç”Ÿæ™‚é–“: ${new Date().toLocaleString()}</p>
    ${htmlContent}
</body>
</html>`;
            }

            function downloadHtml(content, filename) {
                const blob = new Blob([content], { type: 'text/html;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.download = filename;
                a.href = url;
                a.click();
                URL.revokeObjectURL(url);
            }

            function exportXlsx(mode) {
                const tables = elements.displayArea.querySelectorAll('table');
                if (tables.length === 0) {
                    alert('æ²’æœ‰å¯åŒ¯å‡ºçš„è¡¨æ ¼ã€‚');
                    return;
                }

                if (mode === 'selected') {
                    const selectedCheckboxes = elements.displayArea.querySelectorAll('.row-checkbox:checked');
                    if (selectedCheckboxes.length === 0) {
                        alert('è«‹å…ˆå‹¾é¸è¦åŒ¯å‡ºçš„è³‡æ–™åˆ—ã€‚');
                        return;
                    }
                }

                try {
                    const workbook = XLSX.utils.book_new();
                    let sheetIndex = 1;

                    tables.forEach(table => {
                        let dataToExport = [];
                        if (mode === 'all') {
                            dataToExport = extractTableData(table, false);
                        } else if (mode === 'selected') {
                            dataToExport = extractTableData(table, true);
                        }

                        if (dataToExport.length > 0) {
                            const worksheet = XLSX.utils.aoa_to_sheet(dataToExport);
                            const colWidths = calculateColumnWidths(dataToExport);
                            worksheet['!cols'] = colWidths;
                            const sheetName = `Sheet${sheetIndex}`;
                            XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                            sheetIndex++;
                        }
                    });

                    if (workbook.SheetNames.length === 0) {
                        alert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºã€‚');
                        return;
                    }

                    const filename = `report_${mode}_${getCurrentDateString()}.xlsx`;
                    XLSX.writeFile(workbook, filename);
                } catch (err) {
                    console.error('åŒ¯å‡º XLSX æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
                    alert('åŒ¯å‡º XLSX æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + (err.message || 'æœªçŸ¥éŒ¯èª¤'));
                }
            }

            function exportMergedXlsx() {
                const tables = elements.displayArea.querySelectorAll('table');
                if (tables.length === 0) {
                    alert('æ²’æœ‰å¯åŒ¯å‡ºçš„è¡¨æ ¼ã€‚');
                    return;
                }

                try {
                    const workbook = XLSX.utils.book_new();
                    const allData = [];
                    let headerRow = null;
                    let isFirstTable = true;

                    tables.forEach((table, tableIndex) => {
                        const tableData = extractTableData(table, false);
                        if (tableData.length > 0) {
                            if (isFirstTable) {
                                headerRow = tableData[0];
                                allData.push(...tableData);
                                isFirstTable = false;
                            } else {
                                const currentHeader = tableData[0];
                                const headersMatch = JSON.stringify(headerRow) === JSON.stringify(currentHeader);
                                if (!headersMatch) {
                                    console.warn(`è­¦å‘Šï¼šè¡¨æ ¼ ${tableIndex + 1} çš„è¡¨é ­æ ¼å¼èˆ‡ç¬¬ä¸€å€‹è¡¨æ ¼ä¸åŒ`);
                                }
                                allData.push(...tableData.slice(1));
                            }
                        }
                    });

                    if (allData.length <= 1) {
                        alert('æ²’æœ‰è¶³å¤ çš„è³‡æ–™å¯ä»¥åŒ¯å‡ºã€‚');
                        return;
                    }

                    const worksheet = XLSX.utils.aoa_to_sheet(allData);
                    const colWidths = calculateColumnWidths(allData);
                    worksheet['!cols'] = colWidths;
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Merged Data');

                    const filename = `report_merged_${getCurrentDateString()}.xlsx`;
                    XLSX.writeFile(workbook, filename);
                    alert(`æˆåŠŸåˆä½µ ${tables.length} å€‹è¡¨æ ¼ï¼Œå…± ${allData.length - 1} ç­†è³‡æ–™ï¼ˆä¸å«è¡¨é ­ï¼‰`);
                } catch (err) {
                    console.error('åŒ¯å‡ºåˆä½µ XLSX æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
                    alert('åŒ¯å‡ºåˆä½µ XLSX æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + (err.message || 'æœªçŸ¥éŒ¯èª¤'));
                }
            }

            function extractTableData(table, onlySelected) {
                const data = [];
                const headerRow = table.querySelector('thead tr');
                if (headerRow) {
                    const headerData = [];
                    headerRow.querySelectorAll('th').forEach(th => {
                        if (!th.classList.contains('checkbox-cell')) {
                            headerData.push(th.textContent.trim());
                        }
                    });
                    data.push(headerData);
                }

                let rows;
                if (onlySelected) {
                    rows = table.querySelectorAll('tbody .row-checkbox:checked');
                    rows = Array.from(rows).map(cb => cb.closest('tr'));
                } else {
                    rows = table.querySelectorAll('tbody tr:not(.row-hidden-search)');
                }

                rows.forEach(row => {
                    const rowData = [];
                    row.querySelectorAll('td').forEach(td => {
                        if (!td.classList.contains('checkbox-cell')) {
                            rowData.push(td.textContent.trim());
                        }
                    });
                    data.push(rowData);
                });

                return data;
            }

            function calculateColumnWidths(data) {
                if (data.length === 0) return [];
                const colCount = data[0].length;
                const widths = [];

                for (let col = 0; col < colCount; col++) {
                    let maxWidth = 10;
                    data.forEach(row => {
                        if (row[col]) {
                            const cellLength = String(row[col]).length;
                            maxWidth = Math.max(maxWidth, cellLength);
                        }
                    });
                    widths.push({ wch: Math.min(maxWidth + 2, 50) });
                }

                return widths;
            }

            function resetView() {
                if (!state.originalHtmlString) return;
                elements.displayArea.innerHTML = state.originalHtmlString;
                injectCheckboxes();
                elements.searchInput.value = '';
                elements.selectKeywordInput.value = '';
                elements.selectKeywordRegex.checked = false;
                filterTable();
                elements.loadStatusMessage.classList.add('hidden');
                elements.showHiddenBtn.classList.add('hidden');

                const hiddenCount = detectHiddenElements();
                if (hiddenCount > 0) {
                    elements.loadStatusMessage.textContent = 
                        `æ³¨æ„ï¼šå·²é‡è¨­è¡¨æ ¼ï¼Œ${hiddenCount} å€‹éš±è—çš„è¡Œåˆ—å·²é‚„åŸç‚ºéš±è—ç‹€æ…‹ã€‚`;
                    elements.loadStatusMessage.classList.remove('hidden');
                    elements.showHiddenBtn.classList.remove('hidden');
                }
            }

            function resetControls(isNewFile = false) {
                if (isNewFile) {
                    state.originalHtmlString = '';
                    elements.searchInput.value = '';
                    elements.selectKeywordInput.value = '';
                    elements.selectKeywordRegex.checked = false;
                    elements.controlPanel.classList.add('hidden');

                    const controlElements = [
                        elements.selectByKeywordGroup, elements.selectByKeywordBtn,
                        elements.selectEmptyBtn, elements.deleteSelectedBtn,
                        elements.invertSelectionBtn, elements.exportHtmlBtn,
                        elements.exportSelectedBtn, elements.exportXlsxBtn,
                        elements.exportSelectedXlsxBtn, elements.exportMergedXlsxBtn,
                        elements.resetViewBtn, elements.showHiddenBtn,
                        elements.loadStatusMessage
                    ];
                    controlElements.forEach(el => el?.classList.add('hidden'));
                }
            }

            function updateDropAreaDisplay() {
                if (state.loadedTables > 0) {
                    elements.dropArea.classList.add('compact');
                    elements.dropAreaInitial.classList.add('hidden');
                    elements.dropAreaLoaded.classList.remove('hidden');
                    elements.fileCount.textContent = state.loadedTables;
                    
                    // é¡¯ç¤ºæª”æ¡ˆåç¨±ï¼ˆæœ€å¤šé¡¯ç¤º3å€‹ï¼‰
                    const displayNames = state.loadedFiles.slice(0, 3).join(', ');
                    const moreText = state.loadedFiles.length > 3 ? ` åŠå…¶ä»– ${state.loadedFiles.length - 3} å€‹...` : '';
                    elements.fileNames.textContent = displayNames + moreText;
                } else {
                    elements.dropArea.classList.remove('compact');
                    elements.dropAreaInitial.classList.remove('hidden');
                    elements.dropAreaLoaded.classList.add('hidden');
                }
            }

            function clearAllFiles() {
                if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å·²è¼‰å…¥çš„æª”æ¡ˆå—ï¼Ÿ')) return;
                
                state.originalHtmlString = '';
                state.loadedFiles = [];
                state.loadedTables = 0;
                elements.displayArea.innerHTML = '';
                elements.fileInput.value = '';
                
                updateDropAreaDisplay();
                resetControls(true);
            }

            function showControls(hiddenCount) {
                elements.controlPanel.classList.remove('hidden');
                const controlsToShow = [
                    elements.selectByKeywordGroup, elements.selectByKeywordBtn,
                    elements.selectEmptyBtn, elements.deleteSelectedBtn,
                    elements.invertSelectionBtn, elements.exportHtmlBtn,
                    elements.exportSelectedBtn, elements.exportXlsxBtn,
                    elements.exportSelectedXlsxBtn, elements.exportMergedXlsxBtn,
                    elements.resetViewBtn
                ];
                controlsToShow.forEach(el => el?.classList.remove('hidden'));

                if (hiddenCount > 0) {
                    elements.loadStatusMessage.textContent = 
                        `æ³¨æ„ï¼šè¼‰å…¥çš„æª”æ¡ˆä¸­åŒ…å« ${hiddenCount} å€‹è¢« Excel éš±è—çš„è¡Œåˆ—ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ã€Œé¡¯ç¤ºéš±è—çš„è¡Œåˆ—ã€æŒ‰éˆ•ä¾†æŸ¥çœ‹å®ƒå€‘ã€‚`;
                    elements.loadStatusMessage.classList.remove('hidden');
                    elements.showHiddenBtn.classList.remove('hidden');
                }
            }

            return { init };
        })();

        ExcelViewer.init();
    </script>
</body>
</html>
