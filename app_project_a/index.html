<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>總態表格彙總器 (Project A)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="styles.css"> 
    <script src="scripts.js"></script>
</head>
<body>

    <div id="app-container">
        <div class="app-header">
            <h1>📊 動態表格彙總器</h1>
            <div class="version">動態表格彙整(含檢誤/復原功能)</div>
            <div style="margin-top: 10px;">
                <a href="help.html" target="_blank" class="btn btn-outline" style="color:white; border-color:white; text-decoration:none;">📖 開啟使用說明</a>
            </div>
        </div>
        
        <div class="progress-steps">
            <div class="step active" id="step-1"><div class="step-number">1</div><div class="step-label">上傳檔案</div></div>
            <div class="step" id="step-2"><div class="step-number">2</div><div class="step-label">版型與範圍</div></div>
            <div class="step" id="step-3"><div class="step-number">3</div><div class="step-label">欄位對應</div></div>
            <div class="step" id="step-4"><div class="step-number">4</div><div class="step-label">矩陣視圖</div></div>
        </div>
        
        <div id="progress-container" style="display:none; padding: 0 40px; margin-top: 20px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span id="progress-text" style="font-weight:bold; color:#555;">處理中...</span>
                <span id="progress-percent">0%</span>
            </div>
            <div style="background: #e0e0e0; border-radius: 10px; overflow: hidden; height: 10px;">
                <div id="progress-bar" style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.3s;"></div>
            </div>
        </div>

        <div class="app-content">
            
            <div style="text-align: right; margin-bottom: 10px;">
                <button id="undo-btn" class="btn btn-outline" disabled style="padding: 5px 10px; font-size: 0.9em;">↩️ 撤銷</button>
                <button id="redo-btn" class="btn btn-outline" disabled style="padding: 5px 10px; font-size: 0.9em;">↪️ 重做</button>
            </div>

            <div class="section" id="section-upload">
                <h2 class="section-title">批次上傳 Excel 檔案 (Z軸來源)</h2>
                <div id="drop-area">
                    <input type="file" id="file-input" accept=".xlsx,.xls" multiple>
                    <div class="drop-text">拖曳多個 Excel 檔案至此</div>
                    <div class="drop-hint">每個檔案將視為一個基金來源 (Z軸)</div>
                </div>
                <div id="file-list-container"></div>
                <div style="text-align: right; margin-top: 10px;">
                    <button id="clear-btn" class="btn btn-danger-outline" style="display: none;">🗑️ 清除所有檔案</button>
                </div>
            </div>
            
            <div class="section" id="section-preview" style="display:none;">
                <h2 class="section-title">版型選擇與範圍設定</h2>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label class="form-label">選擇報表版型 (Project A)</label>
                        <select id="template-select" style="font-size: 1.1em; padding: 12px; border-color: #667eea; background-color: #f8f9ff;">
                            </select>
                    </div>
                </div>

                <div id="preview-area" style="overflow: auto; max-height: 400px; border: 1px solid #ddd; margin: 15px 0;"></div>
                
                <div class="form-row" style="margin-top:20px;">
                    <button class="btn btn-success" id="auto-detect-btn">🔍 自動偵測範圍</button>
                </div>
            </div>
            
            <div class="section" id="section-range" style="display:none;">
                <div style="background: #f1f3f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-top:0; color:#555;">範圍參數</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">資料範圍 (例如 A1:Z100)</label>
                            <input type="text" id="data-range-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">標頭列數</label>
                            <input type="number" id="header-rows-input" value="1" min="1">
                        </div>
                    </div>
                    <div class="form-row">
                         <button class="btn btn-primary" id="load-headers-btn">📋 讀取欄位並設定</button>
                    </div>
                </div>

                <div id="section-mapping" style="display:none;">
                    <h2 class="section-title">定義維度 (Mapping)</h2>
                    <div class="alert alert-info">
                        💡 設定 <strong>主鍵 (Y軸)</strong> 與 <strong>數值 (X軸)</strong>。Project A 將自動聯集所有檔案的項目。
                    </div>
                    
                    <div class="form-row" style="margin-bottom:15px;">
                         <button class="btn btn-success" id="transpose-btn">🔄 欄列轉置</button>
                         <div id="transpose-controls" style="display:none; margin-left: 10px;">
                             <select id="transpose-key-select" style="padding: 8px;"></select>
                         </div>
                    </div>

                    <div id="mapping-fields"></div>
                    
                    <div class="form-row" style="margin-top:20px;">
                        <button class="btn btn-primary" id="process-btn" style="font-size: 1.2em; padding: 15px 40px;">⚡ 開始矩陣彙總</button>
                    </div>
                </div>
            </div>
            
            <div class="output-section" id="output-area">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
                    <h2 class="section-title" style="margin-bottom: 0; border:none;">彙總矩陣結果</h2>
                    <div class="export-controls">
                        <button class="btn btn-outline" id="export-json-btn">JSON</button>
                        <button class="btn btn-outline" id="export-csv-btn">CSV</button>
                        <button class="btn btn-outline" id="export-html-btn">HTML</button>
                        <button class="btn btn-outline" id="export-xlsx-btn">XLSX</button>
                    </div>
                </div>

                <div class="view-tabs">
                    <button class="tab-btn active" data-view="summary-view">📊 矩陣總表</button>
                    <button class="tab-btn" data-view="file-query-view">📁 檔案查詢</button>
                    <button class="tab-btn" data-view="item-query-view">🔍 項目查詢</button>
                </div>
                
                <div id="view-content" style="background: white; padding: 20px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    <div id="summary-view" class="view-pane active"></div>
                    <div id="file-query-view" class="view-pane">
                        <select class="query-select" id="file-dropdown" style="width: 100%; padding: 10px; margin-bottom: 15px;"></select>
                        <div id="file-detail-table"></div>
                    </div>
                    <div id="item-query-view" class="view-pane">
                        <select class="query-select" id="item-dropdown" style="width: 100%; padding: 10px; margin-bottom: 15px;"></select>
                        <div id="item-detail-table"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="scripts.js"></script>
</body>

</html>


